# 创建水位数据新表
CREATE TABLE `waterhisdata_new` (
  `NewID` int(11) DEFAULT NULL,
  `DeviceLocation` varchar(64) NOT NULL,
  `WaterHisDataID` varchar(64) NOT NULL,
  `DeviceID` varchar(50) NOT NULL,
  `Water` decimal(18,3) NOT NULL,
  `Flow` decimal(18,3) NOT NULL,
  `CollectionTime` datetime NOT NULL,
  `WaterFlowType` smallint(6) NOT NULL,
  `UpdateTime` datetime DEFAULT NULL,
  PRIMARY KEY (`DeviceID`, `CollectionTime`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8

insert into waterhisdata_new values (1,'无位置信息','d6c7b01c-7bb5-4440-8e09-511de7c63fcd','WJGL001P771',0.000,0.000,'2017-12-29 20:00:00',0,'2017-12-29 19:56:51')

# 创建降雨量数据新表
CREATE TABLE `rainfalldata_new` (
  `NewID` int(11) DEFAULT NULL,
  `DeviceLocation` varchar(64) NOT NULL,
  `DeviceID` varchar(50) NOT NULL,
  `CollectionTime` datetime NOT NULL,
  `RainfallType` char(3) NOT NULL COMMENT '值范围: ‘1H’---1小时雨量,‘3H’---3小时雨量,‘6H’---6小时雨量,‘12H’---12小时雨量',
  `RainfallValue` decimal(18,3) DEFAULT NULL,
  `RainRC` int(11) DEFAULT NULL,
  `UpDateTime` datetime DEFAULT NULL,
  PRIMARY KEY (`DeviceID`,`CollectionTime`,`RainfallType`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='小时雨量'

insert into rainfalldata_new values (1,'无位置信息','000020170332','2018-01-04 16:05:00','ADD',0.000,50,'2018-01-04 17:00:34')

# 创建土壤含水率数据新表
CREATE TABLE `specparamscollect_new` (
  `NewID` int(11) DEFAULT NULL,
  `DeviceLocation` varchar(64) NOT NULL,
  `DeviceID` varchar(50) NOT NULL,
  `CollectionTime` datetime NOT NULL,
  `Dcm_Para1` decimal(16,2) DEFAULT NULL,
  `Dcm_Para2` decimal(16,2) DEFAULT NULL,
  `Dcm_Para3` decimal(16,2) DEFAULT NULL,
  `Dcm_Para4` decimal(16,2) DEFAULT NULL,
  `Dcm_Para5` decimal(16,2) DEFAULT NULL,
  `Dcm_Para6` decimal(16,2) DEFAULT NULL,
  `Dcm_Para7` decimal(16,2) DEFAULT NULL,
  `Dcm_Para8` decimal(16,2) DEFAULT NULL,
  `Dcm_Para9` decimal(16,2) DEFAULT NULL,
  `Dcm_Para10` decimal(16,2) DEFAULT NULL,
  PRIMARY KEY (`DeviceID`,`CollectionTime`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='土壤含水率数据'

insert into specparamscollect_new (NewID, devicelocation, deviceid, collectiontime, Dcm_Para1, Dcm_Para8) values (1, '甘洛县日坡沟2号', 'GALX000006','2021-01-01 00:00:00',0.00,11.00)

# 查询最早的传感器数据
SELECT * FROM [dbo].['table_name'] where DeviceID = 'deviceid' and CollectionTime=(SELECT min(CollectionTime) from [dbo].['table_name'] where DeviceID = 'deviceid')

# 插入新的传感器数据(mysql database)
replace into rainfalldata VALUES ('6D005900135056594D373420','2022-05-30 23:55:12.000','ADD','.000','50','2022-07-12 15:45:12.000')
replace into rainfalldata VALUES ('50002E001150565648383120', '2022-05-31 00:30:12.000', 'ADD', '.000', '50', '2022-07-12 15:45:12.000')

replace into waterhisdata VALUES ('598e7b0fa32d67858b252586dd8b4e7b', '4D002E000C50475842303620', '.000', '4.330', '2022-05-30 23:57:45.000',	'0', '2022-06-14 16:53:36.000')

replace into specparamscollect(DeviceID, CollectionTime, Dcm_Para1, Dcm_Para8) VALUES ('50002E001150565648383120', '2022-05-31 00:30:12.000', '17.30', '14.70')
replace into specparamscollect(DeviceID, CollectionTime, Dcm_Para1, Dcm_Para8) VALUES ('6D005900135056594D373420', '2022-05-30 23:55:12.000', '.00', '17.90')

# 插入新的传感器数据(mysql new database)
replace into rainfalldata_new VALUES ('1', '茂县三道桥沟2号', '6D005900135056594D373420','2022-05-30 23:55:12.000','ADD','.000','50','2022-07-12 15:45:12.000')
replace into rainfalldata_new VALUES ('1', '茂县三道桥沟1号', '50002E001150565648383120', '2022-05-31 00:30:12.000', 'ADD', '.000', '50', '2022-07-12 15:45:12.000')

replace into waterhisdata_new VALUES ('1', '茂县三道桥沟3号', '598e7b0fa32d67858b252586dd8b4e7b', '4D002E000C50475842303620', '.000', '4.330', '2022-05-30 23:57:45.000', '0', '2022-06-14 16:53:36.000')

replace into specparamscollect_new(NewID, DeviceLocation, DeviceID, CollectionTime, Dcm_Para1, Dcm_Para8) VALUES ('1', '茂县三道桥沟1号', '50002E001150565648383120', '2022-05-31 00:30:12.000', '17.30', '14.70')
replace into specparamscollect_new(NewID, DeviceLocation, DeviceID, CollectionTime, Dcm_Para1, Dcm_Para8) VALUES ('1', '茂县三道桥沟2号', '6D005900135056594D373420', '2022-05-30 23:55:12.000', '.00', '17.90')

replace into devicestate(DeviceStateID, DeviceID, BatteryVoltage, CollectionTime, OtherState1) values('675ad3c2edf983b6a2ae49190a9a5869','SDQG000003','13.00','2022-07-21 00:00:54.000','20.00')
replace into devicestate(DeviceStateID, DeviceID, BatteryVoltage, CollectionTime, OtherState1) values('04702d399ed67120774675cba3d2ae69','SDQG000005','12.96','2022-07-21 00:25:12.000','20.00')
replace into devicestate(DeviceStateID, DeviceID, BatteryVoltage, CollectionTime, OtherState1) values('1760fbd30c44f7c6fc021a065f76fc25','SDQG000006','13.00','2022-07-21 00:30:12.000','20.00')

# 删除错误数据
delete from rainfalldata_new where deviceid = '6D005900135056594D373420' and CollectionTime > '2022-05-30 23:55:12.000'
delete from rainfalldata_new where deviceid = '50002E001150565648383120' and CollectionTime > '2022-05-31 00:30:12.000'

delete from waterhisdata_new where deviceid = '4D002E000C50475842303620' and CollectionTime > '2022-05-30 23:57:45.000'

delete from specparamscollect_new where deviceid = '50002E001150565648383120' and CollectionTime > '2022-05-31 00:30:12.000'
delete from specparamscollect_new where deviceid = '6D005900135056594D373420' and CollectionTime > '2022-05-30 23:55:12.000'

# 查询插入的新传感器信息
select count(1) as count_num, DeviceID from table_name where DeviceID in ('50002E001150565648383120', '6D005900135056594D373420', '4D002E000C50475842303620') group by DeviceID

# 更新表结构
alter table waterhisdata_new add abnormal int(1)
alter table waterhisdata_new add index newID(NewID)
show index from waterhisdata_new

alter table specparamscollect_new add abnormal int(1)
alter table specparamscollect_new add index newID(NewID)
show index from specparamscollect_new

# 初始化新表需要改动部分初始化条件，详见代码注释

# 创建用户信息表单
CREATE TABLE if not exists `watersys_user` (
  `UserId` int(11) NOT NULL AUTO_INCREMENT,
  `UserName` varchar(64) NOT NULL,
  `UserKey` varchar(64) NOT NULL,
  `LoadStatus` varchar(50) NOT NULL,
  `RegisterTime` datetime NOT NULL,
  `LastLoadTime` datetime NOT NULL,
	`PhoneNumber` int(11) DEFAULT NULL,
	`EmailAddress` varchar(50) DEFAULT NULL,
  PRIMARY KEY (`UserName`, `LoadStatus`, `LastLoadTime`),
	KEY (`UserId`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8

# 插入测试用户：test_admin, test_keyword
insert into watersys_user (UserName, UserKey, LoadStatus, RegisterTime, LastLoadTime) values ('test_admin', '320c468debbcd23e064685c972592da9', 'Y', '2022-4-26 12:00:00', '2022-4-26 12:00:00')
